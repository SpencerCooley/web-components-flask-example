<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="leaflet-import.html">


<!--
Element which defines an icon template for markers (<a href="http://leafletjs.com/reference.html#icon">Leaflet Reference</a>).

##### Example

    <leaflet-icon id="myicon"
    	iconurl="https://stendhalgame.org/images/mapmarker/me.png">
    </leaflet-icon>

@element leaflet-icon
@blurb element which defines an icon template for markers.
@status beta
@homepage https://nhnb.github.io/leaflet-map/
-->
<polymer-element name="leaflet-icon" attributes="iconUrl iconRetinaUrl iconWidth iconHeight iconAnchorX iconAnchorY shadowUrl shadowRetinaUrl shadowWidth shadowHeight shadowAnchorX shadowAnchorY popupAnchorX popupAnchorY className">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	"use strict";

	Polymer('leaflet-icon', {

		/**
		 * The `iconUrl` attribute sets the URL to the icon image (absolute or relative to your script path).
		 * 
		 * @attribute iconUrl
		 * @type string 
		 */
		iconUrl: undefined,

		/**
		 * The `iconRetinaUrl` attribute sets the URL to a retina sized version of the icon image (absolute or relative to your script path). Used for Retina screen devices.
		 * 
		 * @attribute iconRetinaUrl
		 * @type string
		 */
		iconRetinaUrl: undefined,

		/**
		 * The `iconWidth` attribute sets the size of the icon image in pixels. 
		 * 
		 * @attribute iconWidth
		 * @type number
		 */
		iconWidth: undefined,

		/**
		 * The `iconHeight` attribute sets the size of the icon image in pixels.
		 * 
		 * @attribute iconHeight
		 * @type number
		 */
		iconHeight: undefined,

		/**
		 * The `iconAnchorX` attribute sets the coordinates of the "tip" of the icon (relative to its top left corner). The icon will be aligned so that this point is at the marker's geographical location. Centered by default if size is specified, also can be set in CSS with negative margins.
		 * 
		 * @attribute iconAnchorX
		 * @type number
		 */
		iconAnchorX: undefined,

		/**
		 * The `iconAnchorY` attribute sets the coordinates of the "tip" of the icon (relative to its top left corner). The icon will be aligned so that this point is at the marker's geographical location. Centered by default if size is specified, also can be set in CSS with negative margins.
		 * 
		 * @attribute iconAnchorY
		 * @type number
		 */
		iconAnchorY: undefined,

		/**
		 * The `shadowUrl` attribute sets the URL to the icon shadow image. If not specified, no shadow image will be created.
		 * 
		 * @attribute shadowUrl
		 * @type string
		 */
		shadowUrl: undefined,

		/**
		 * The `shadowRetinaUrl` attribute sets the URL to the retina sized version of the icon shadow image. If not specified, no shadow image will be created. Used for Retina screen devices.
		 * 
		 * @attribute shadowRetinaUrl
		 * @type string
		 */
		shadowRetinaUrl: undefined,

		/**
		 * The `shadowWidth` attribute sets the size of the shadow image in pixels.
		 * 
		 * @attribute shadowWidth
		 * @type number
		 */
		shadowWidth: undefined,

		/**
		 * The `shadowHeight` attribute sets the size of the shadow image in pixels.
		 * 
		 * @attribute shadowHeight
		 * @type number
		 */
		shadowHeight: undefined,

		/**
		 * The `shadowAnchorX` attribute sets the coordinates of the "tip" of the shadow (relative to its top left corner) (the same as iconAnchor if not specified).
		 * 
		 * @attribute shadowAnchorX
		 * @type number
		 */
		shadowAnchorX: undefined,

		/**
		 * The `shadowAnchorY` attribute sets the coordinates of the "tip" of the shadow (relative to its top left corner) (the same as iconAnchor if not specified).
		 * 
		 * @attribute shadowAnchorY
		 * @type number
		 */
		shadowAnchorY: undefined,

		/**
		 * The `popupAnchorX` attribute sets the coordinates of the point from which popups will "open", relative to the icon anchor.
		 * 
		 * @attribute popupAnchorX
		 * @type number
		 */
		popupAnchorX: undefined,

		/**
		 * The `popupanchory` attribute sets the coordinates of the point from which popups will "open", relative to the icon anchor.
		 * 
		 * @attribute popupAnchorY
		 * @type number
		 */
		popupAnchorY: undefined,

		/**
		 * The `className` attribute sets a custom class name to assign to both icon and shadow images. Empty by default.
		 * 
		 * @attribute className
		 * @type string
		 */
		className: "",

		icon_: null,

		getIcon: function() {
			if (this.icon_) {
				return this.icon_;
			}
			var icon = {
				iconUrl: this.iconUrl,
				iconRetinaUrl: this.iconRetinaUrl,
				shadowUrl: this.shadowUrl,
				shadowRetinaUrl: this.shadowRetinaUrl,
				className: this.className
			};
			if (this.iconWidth && this.iconHeight) {
				icon.iconSize = L.point(this.iconWidth, this.iconHeight);
			}
			if (this.iconAnchorX && this.iconAnchorY) {
				icon.iconAnchor = L.point(this.iconAnchorX, this.iconAnchorY);
			}
			if (this.shadowWidth && this.shadowHeight) {
				icon.shadowSize = L.point(this.shadowWidth, this.shadowHeight);
			}
			if (this.shadowAnchorX && this.shadowAnchorY) {
				icon.shadowAnchor = L.point(this.shadowAnchorX, this.shadowAnchorY);
			}
			if (this.popupAnchorX && this.popupAnchorY) {
				icon.popupAnchor = L.point(this.popupAnchorX, this.popupAnchorY);
			}
			
			this.icon_ = L.icon(icon);
			return this.icon_;
		},
		
		attributeChanged: function() {
			this.icon_ = null;
		}
	});
	</script>
</polymer-element>






<!--
Element which defines an divicon template for markers (<a href="http://leafletjs.com/reference.html#divicon">Leaflet Reference</a>).

##### Example

    <leaflet-divicon id="myicon" classname="name">
    	<a href="https://nhnb.github.io/leaflet-map/demo.html">Demo</a>
    </leaflet-icon>

@element leaflet-divicon
@blurb element which defines an divicon template for markers.
@status beta
@homepage https://nhnb.github.io/leaflet-map/
-->
<polymer-element name="leaflet-divicon" attributes="iconWidth iconHeight iconAnchorX iconAnchorY className">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	"use strict";

	Polymer('leaflet-divicon', {

		/**
		 * The `iconWidth` attribute sets the size of the icon image in pixels. 
		 * 
		 * @attribute iconWidth
		 * @type number
		 */
		iconWidth: undefined,

		/**
		 * The `iconHeight` attribute sets the size of the icon image in pixels.
		 * 
		 * @attribute iconHeight
		 * @type number
		 */
		iconHeight: undefined,

		/**
		 * The `iconAnchorX` attribute sets the coordinates of the "tip" of the icon (relative to its top left corner). The icon will be aligned so that this point is at the marker's geographical location. Centered by default if size is specified, also can be set in CSS with negative margins.
		 * 
		 * @attribute iconAnchorX
		 * @type number
		 */
		iconAnchorX: undefined,

		/**
		 * The `iconAnchorY` attribute sets the coordinates of the "tip" of the icon (relative to its top left corner). The icon will be aligned so that this point is at the marker's geographical location. Centered by default if size is specified, also can be set in CSS with negative margins.
		 * 
		 * @attribute iconAnchorY
		 * @type number
		 */
		iconAnchorY: undefined,

		/**
		 * The `className` attribute sets a custom class name to assign to both icon and shadow images. Empty by default.
		 * 
		 * @attribute className
		 * @type string
		 */
		className: "",


		icon_: null,

		getIcon: function() {
			if (this.icon_) {
				return this.icon_;
			}
			var icon = {
				className: this.className,
				html: this.innerHTML
			};
			if (this.iconWidth && this.iconHeight) {
				icon.iconSize = L.point(this.iconWidth, this.iconHeight);
			}
			if (this.iconAnchorX && this.iconAnchorY) {
				icon.iconAnchor = L.point(this.iconAnchorX, this.iconAnchorY);
			}
			this.icon_ = L.divicon(icon);
			return this.icon_;
		},

		attributeChanged: function() {
			this.icon_ = null;
		}
	});
	</script>
</polymer-element>









<!--
Element which defines a maker  (<a href="http://leafletjs.com/reference.html#marker">Leaflet Reference</a>).

##### Example

	<leaflet-marker latitude="51.5" longitude="-0.10" title="Some title">
		<b>Popup text</b>
	</leaflet-marker>

##### Example

	<leaflet-icon id="myicon" iconurl="https://stendhalgame.org/images/mapmarker/me.png"></leaflet-icon>

	<leaflet-marker latitude="51.5" longitude="-0.10" title="Some title" icon="myicon">
	</leaflet-marker>

@element leaflet-marker
@blurb element which defines a marker. The content is used as popup window, unless it is empty.
@status beta
@homepage https://nhnb.github.io/leaflet-map/
-->
<polymer-element name="leaflet-marker" attributes="latitude longitude icon clickable dragable keyboard title alt zIndexOffset opacity riseOnHover riseOffset">
	<template>
		<style>
			:host {
				display: none;
			}
		</style>
	</template>
	<script>
	"use strict";

	Polymer('leaflet-marker', {
		/**
		 * Fired when the user clicks (or taps) the marker.
		 * 
		 * @event click
		 * @type MouseEvent
		 * @param {LatLng} latlng The geographical point where the mouse event occured.
		 * @param {Point} layerPoint Pixel coordinates of the point where the mouse event occured relative to the map layer.
		 * @param {Point} containerPoint Pixel coordinates of the point where the mouse event occured relative to the map сontainer.
		 * @param {DOMMouseEvent} originalEvent The original DOM mouse event fired by the browser.
		 */

		/**
		 * Fired when the user double-clicks (or double-taps) the marker.
		 * 
		 * @event dblclick
		 * @type MouseEvent
		 * @param {LatLng} latlng The geographical point where the mouse event occured.
		 * @param {Point} layerPoint Pixel coordinates of the point where the mouse event occured relative to the map layer.
		 * @param {Point} containerPoint Pixel coordinates of the point where the mouse event occured relative to the map сontainer.
		 * @param {DOMMouseEvent} originalEvent The original DOM mouse event fired by the browser.
		 */

		/**
		 * Fired when the user pushes the mouse button on the marker.
		 * 
		 * @event mousedown
		 * @type MouseEvent
		 * @param {LatLng} latlng The geographical point where the mouse event occured.
		 * @param {Point} layerPoint Pixel coordinates of the point where the mouse event occured relative to the map layer.
		 * @param {Point} containerPoint Pixel coordinates of the point where the mouse event occured relative to the map сontainer.
		 * @param {DOMMouseEvent} originalEvent The original DOM mouse event fired by the browser.
		 */

		/**
		 * Fired when the mouse enters the marker.
		 * 
		 * @event mouseover
		 * @type MouseEvent
		 * @param {LatLng} latlng The geographical point where the mouse event occured.
		 * @param {Point} layerPoint Pixel coordinates of the point where the mouse event occured relative to the map layer.
		 * @param {Point} containerPoint Pixel coordinates of the point where the mouse event occured relative to the map сontainer.
		 * @param {DOMMouseEvent} originalEvent The original DOM mouse event fired by the browser.
		 */
		
		/**
		 * Fired when the mouse leaves the marker.
		 * 
		 * @event mouseout
		 * @type MouseEvent
		 * @param {LatLng} latlng The geographical point where the mouse event occured.
		 * @param {Point} layerPoint Pixel coordinates of the point where the mouse event occured relative to the map layer.
		 * @param {Point} containerPoint Pixel coordinates of the point where the mouse event occured relative to the map сontainer.
		 * @param {DOMMouseEvent} originalEvent The original DOM mouse event fired by the browser.
		 */
		
		/**
		 * Fired when the user right-clicks on the marker.
		 * 
		 * @event contextmenu
		 * @type MouseEvent
		 */

		/**
		 * Fired when the user starts dragging the marker.
		 * 
		 * @event dragstart
		 */

		/**
		 * Fired repeatedly while the user drags the marker.
		 * 
		 * @event drag
		 */

		/**
		 * Fired when the user stops dragging the marker.
		 * 
		 * @event dragend
		 * @type DragEndEvent
		 * @param {number} distance The distance in pixels the draggable element was moved by.
		 */

		/**
		 * Fired when the marker is moved via setLatLng. New coordinate include in event arguments.
		 * 
		 * @event move
		 * @type 
		 */

		/**
		 * Fired when the marker is added to the map.
		 * 
		 * @event add
		 * @type 
		 */

		/**
		 * Fired when the marker is removed from the map.
		 * 
		 * @event remove
		 */

		/**
		 * Fired when a popup bound to the marker is open.
		 * 
		 * @event popupopen
		 * @type PopupEvent
		 * @param {Popup} popup The popup that was opened or closed.
		 */

		 /**
		 * Fired when a popup bound to the marker is closed.
		 * 
		 * @event popupclose
		 * @type PopupEvent
		 * @param {Popup} popup The popup that was opened or closed.
		 */

		publish: {
			/**
			 * The `latitude` attribute sets the positions of the marker.
			 *
			 * @attribute latitude
			 * @type number
			 */
			latitude: {value: null, reflect: true},

			/**
			 * The `longitude` attribute sets the positions of the marker.
			 *
			 * @attribute longitude
			 * @type number
			 */
			longitude: {value: null, reflect: true}
		},

		/**
		 * The `icon` attribute sets the Icon class to use for rendering the marker. 
		 * This attribute may be refer to an id-attribute of an leaflet-icon-element,
		 * contain json syntax or it be assigned an instance of L.icon.
		 * See Icon documentation for details on how to customize the marker icon. Set to new L.Icon.Default() by default.
		 * 
		 * @attribute icon
		 * @type string, json or L.icon
		 */
		icon: undefined,

		/**
		 * If `clickable` attribute is set to false, the marker will not emit mouse events and will act as a part of the underlying map.
		 * 
		 * @attribute clickable
		 * @type bool
		 */
		clickable: true,

		/**
		 * The `dragable` attribute sets the whether the marker is draggable with mouse/touch or not.
		 * 
		 * @attribute dragable
		 * @type bool
		 */
		dragable: false,

		/**
		 * The `keyboard` attribute sets the whether the marker is draggable with mouse/touch or not.
		 * 
		 * @attribute dragable
		 * @type bool
		 */
		keyboard: true,

		/**
		 * The `title` attribute sets the text for the browser tooltip that appear on marker hover (no tooltip by default).
		 * 
		 * @attribute title
		 * @type string
		 */
		title: '',

		/**
		 * The `alt` attribute sets the text for the alt attribute of the icon image (useful for accessibility).
		 * 
		 * @attribute alt
		 * @type string
		 */
		alt: '',

		/**
		 * The `zIndexOffset` attribute sets the zIndexOffset. By default, marker images zIndex is set automatically based on its latitude
		 * 
		 * @attribute zIndexOffset
		 * @type number
		 */
		zIndexOffset: 0,

		/**
		 * The `opacity` attribute sets the opacity of the marker.
		 * 
		 * @attribute opacity
		 * @type number
		 */
		opacity: 1.0,

		/**
		 * The `riseOnHover` attribute sets the whether the marker will get on top of others when you hover the mouse over it. 
		 * 
		 * @attribute riseOnHover
		 * @type bool
		 */
		riseOnHover: false,

		/**
		 * The `riseOffset` attribute sets the z-index offset used for the riseOnHover feature.
		 * 
		 * @attribute riseOffset
		 * @type number
		 */
		riseoffset: 250,

		feature: undefined,
		
		observer_: undefined,

		observe: {
			latitude: 'positionChanged',
			longitude: 'positionChanged',
		},

		containerChanged: function() {
			if (this.container) {

				var feature = L.marker([this.latitude, this.longitude], {
					clickable: this.clickable,
					dragable: this.dragable,
					keyboard: this.keyboard,
					title: this.title,
					alt: this.alt,
					zindexOffset: this.zIndexOffset,
					opacity: this.opacity,
					riseOnHover: this.riseOnHover,
					riseOffset: this.riseOffset,
				});
				this.feature = feature;
				this.iconChanged();

				// forward events
				feature.on('click dblclick mousedown mouseover mouseout contextmenu dragstart drag dragend move add remove popupopen popupclose', function(e) {
					this.fire(e.type, e);
				}, this);

				// update popup on content changes
				this.childrenMutated();
				if (MutationObserver && !this.observer_) {
					this.observer_ = new MutationObserver(this.childrenMutated.bind(this));
					this.observer_.observe(this, {childList: true, characterData: true, attributes: true, subtree: true});
				}
				this.feature.addTo(this.container);
			}
		},

		iconChanged: function() {
			// icon support
			var iconOption;
			if (this.icon) {
				if (typeof this.icon == "string") {
					var iconElement = document.getElementById(this.icon);
					if (iconElement != null) {
						if (iconElement.getIcon) {
							iconOption = iconElement.getIcon();
						}
					} else {
						try {
							iconOption = L.icon(JSON.parse(this.icon));
						} catch (e) {
							iconOption = new L.Icon.Default();
						}
					}
				} else {
					iconOption = this.icon;
				}
			}
			if (!iconOption) {
				iconOption = new L.Icon.Default();
			}
			if (this.feature) {
				this.feature.setIcon(iconOption);
			}
		},

		positionChanged: function() {
			if (this.feature) {
				this.feature.setLatLng(L.LatLng(this.latitude, this.longitude));
			}
		},

		zIndexOffsetChanged: function() {
			if (this.feature) {
				this.feature.setZIndexOffset(this.zIndexOffset);
			}
		},

		opacityChanged: function() {
			if (this.feature) {
				this.feature.setOpacity(this.opacity);
			}
		},
		
		childrenMutated: function() {
			this.feature.unbindPopup();
			if (this.innerHTML.trim()) {
				this.feature.bindPopup(this.innerHTML);
			}
		},
		
		detached: function() {
			if (this.container && this.feature) {
				this.container.removeLayer(this.feature);
			}
			if (observer_) {
				observer.disconnect();
			}
		}

	});
	</script>
</polymer-element>

